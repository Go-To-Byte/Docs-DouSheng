<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>做了2次架构演变，算是入了微服务的门吧~ | Go-To-Byte 抖声项目文档</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="极简版抖音相关文档">
    
    <link rel="preload" href="/Docs-DouSheng/assets/css/0.styles.8eec8595.css" as="style"><link rel="preload" href="/Docs-DouSheng/assets/js/app.536cc449.js" as="script"><link rel="preload" href="/Docs-DouSheng/assets/js/3.7c9615c7.js" as="script"><link rel="preload" href="/Docs-DouSheng/assets/js/1.09f60839.js" as="script"><link rel="preload" href="/Docs-DouSheng/assets/js/11.fffa9699.js" as="script"><link rel="prefetch" href="/Docs-DouSheng/assets/js/10.0a13617d.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/12.f2b67662.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/13.d6a0ee73.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/14.e3110fe4.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/15.a8ab4c1a.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/16.86137cae.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/17.5e3e25b8.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/18.39b132cd.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/19.4556075a.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/20.d09eb622.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/21.18e033bd.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/22.cf2715e5.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/23.e6032951.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/24.5ddaaff3.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/25.8adde32e.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/26.f25ffe9c.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/27.860e4be6.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/28.386efccb.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/29.fb168c62.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/4.c941b0df.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/5.1472538b.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/6.bba527e6.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/7.b9d4e63c.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/8.3cee3583.js"><link rel="prefetch" href="/Docs-DouSheng/assets/js/9.e5d8ba77.js">
    <link rel="stylesheet" href="/Docs-DouSheng/assets/css/0.styles.8eec8595.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-717a9a92><div data-v-717a9a92><div class="password-shadow password-wrapper-out" style="display:none;" data-v-045785d8 data-v-717a9a92 data-v-717a9a92><h3 class="title" data-v-045785d8>Go-To-Byte 抖声项目文档</h3> <p class="description" data-v-045785d8>极简版抖音相关文档</p> <label id="box" class="inputBox" data-v-045785d8><input type="password" value="" data-v-045785d8> <span data-v-045785d8>Konck! Knock!</span> <button data-v-045785d8>OK</button></label> <div class="footer" data-v-045785d8><span data-v-045785d8><i class="iconfont reco-theme" data-v-045785d8></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-045785d8>vuePress-theme-reco</a></span> <span data-v-045785d8><i class="iconfont reco-copyright" data-v-045785d8></i> <a data-v-045785d8><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-717a9a92><header class="navbar" data-v-717a9a92><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Docs-DouSheng/" class="home-link router-link-active"><!----> <span class="site-name">Go-To-Byte 抖声项目文档</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Docs-DouSheng/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="https://github.com/Go-To-Byte/DouSheng" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-717a9a92></div> <aside class="sidebar" data-v-717a9a92><div class="personal-info-wrapper" data-v-737b5069 data-v-717a9a92><!----> <!----> <div class="num" data-v-737b5069><div data-v-737b5069><h3 data-v-737b5069>20</h3> <h6 data-v-737b5069>文章</h6></div> <div data-v-737b5069><h3 data-v-737b5069>0</h3> <h6 data-v-737b5069>标签</h6></div></div> <ul class="social-links" data-v-737b5069></ul> <hr data-v-737b5069></div> <nav class="nav-links"><div class="nav-item"><a href="/Docs-DouSheng/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="https://github.com/Go-To-Byte/DouSheng" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/Docs-DouSheng/" class="sidebar-heading clickable router-link-active"><span>欢迎查看</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Docs-DouSheng/" aria-current="page" class="sidebar-link">关于</a></li><li><a href="/Docs-DouSheng/index/team.html" class="sidebar-link">Go-To-Byte</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/Docs-DouSheng/handbook/why" class="sidebar-heading clickable"><span>初识Dousheng</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Docs-DouSheng/handbook/why.html" class="sidebar-link">为什么选择 Go</a></li><li><a href="/Docs-DouSheng/handbook/start.html" class="sidebar-link">开始</a></li><li><a href="/Docs-DouSheng/handbook/feature.html" class="sidebar-link">功能特点</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/Docs-DouSheng/framework/evolve" class="sidebar-heading clickable open active"><span>Dousheng的相关架构</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Docs-DouSheng/framework/evolve.html" aria-current="page" class="active sidebar-link">Dousheng的架构演变之路</a></li><li><a href="/Docs-DouSheng/framework/lifecycle.html" class="sidebar-link">如何管理DouSheng应用的生命周期</a></li><li><a href="/Docs-DouSheng/framework/ioc.html" class="sidebar-link">如何将IoC使用到架构中</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Docs-DouSheng/kit/base" class="sidebar-heading clickable"><span>Dousheng的公共库</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Docs-DouSheng/service/user" class="sidebar-heading clickable"><span>Dousheng的业务实现</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Docs-DouSheng/other/gowork" class="sidebar-heading clickable"><span>其他</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-045785d8 data-v-717a9a92><h3 class="title" data-v-045785d8>做了2次架构演变，算是入了微服务的门吧~</h3> <!----> <label id="box" class="inputBox" data-v-045785d8><input type="password" value="" data-v-045785d8> <span data-v-045785d8>Konck! Knock!</span> <button data-v-045785d8>OK</button></label> <div class="footer" data-v-045785d8><span data-v-045785d8><i class="iconfont reco-theme" data-v-045785d8></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-045785d8>vuePress-theme-reco</a></span> <span data-v-045785d8><i class="iconfont reco-copyright" data-v-045785d8></i> <a data-v-045785d8><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-717a9a92><div data-v-717a9a92><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">做了2次架构演变，算是入了微服务的门吧~</h1> <div data-v-4841c148><i class="iconfont reco-account" data-v-4841c148><span data-v-4841c148>Ciusyan</span></i> <i class="iconfont reco-date" data-v-4841c148><span data-v-4841c148>2023/2/20</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="做了2次架构演变-算是入了微服务的门吧"><a href="#做了2次架构演变-算是入了微服务的门吧" class="header-anchor">#</a> 做了2次架构演变，算是入了微服务的门吧~</h1> <h2 id="一、初见dousheng"><a href="#一、初见dousheng" class="header-anchor">#</a> 一、初见Dousheng</h2> <h3 id="_1-架构思路"><a href="#_1-架构思路" class="header-anchor">#</a> （1）架构思路</h3> <p>因为自己以前是一个<code>Javer</code>，对传统的<code>MVC</code>三层架构还算比较熟悉，就巨石架构而言，使用<code>MVC</code>的架构方式，模块还算是比较清晰了。</p> <p>因为接触了一门新的语言<code>GoLang</code>，利用一些熟悉的事物过渡到不太熟悉的领域。是我们人性所趋。</p> <p>所以在Dousheng的架构演变过程中，借鉴了MVC的思想，引入<code>似MVC</code>的架构方式。</p> <p>也就是：</p> <ol><li>控制层<code>（Handler）</code>：用于控制网络请求。</li> <li>业务层<code>（Service）</code>：用于处理具体业务，还有简单的数据库操作。</li> <li>持久层<code>（Dao）</code>：用于进行数据库的操作。</li></ol> <p>又因为没有类似Spring的框架来管理依赖<code>（虽然我们的项目中引入了IoC，在后面介绍~）</code>，我们这里并没有严格的区分业务层和持久层。所以我们最初的架构是&quot;两层半&quot;：<code>Handler -&gt; Service + Dao</code>。</p> <p>了解了初次架构的设计思路后，我们来看一些直观的表达。</p> <h4 id="_1、架构图"><a href="#_1、架构图" class="header-anchor">#</a> 1、架构图</h4> <p>简单画一幅图来表示上面的思路就是：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4981e2df260f4229bac6f2644d78cb39~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20230220003052506"></p> <p>这样比较传统的单体架构，较容易理解，就不多解释了。直接来看看拆分后的目录结构。</p> <h4 id="_2、目录结构"><a href="#_2、目录结构" class="header-anchor">#</a> 2、目录结构</h4> <p>再来看看架构的目录结构，一些辅助包，暂时不需要关注，可查看对应的文档。现在只需要关注业务模块的分层即可。</p> <h5 id="目录结构概览-解读"><a href="#目录结构概览-解读" class="header-anchor">#</a> 目录结构概览[解读]</h5> <div class="language-tex extra-class"><pre class="language-tex"><code>DouSheng            # 极简版抖音 APP
├── apps            # 所有服务模块
│   ├── all         # 统一管理所有模块实例的注册<span class="token punctuation">[</span>驱动加载的方式<span class="token punctuation">]</span>
│   ├── comment     # ===评论模块===
│   │   ├── api     # 控制层(Handler)
│   │   ├── impl    # 业务层(Service) + 持久层(Dao)
│   │   └── pb	    # interface 、model 
│   ├── user        # ===用户模块===
│   │   ├── api     
│   │   ├── impl
│   │   └── pb
│   └── video       # ===视频模块===
│       ├── api
│       ├── impl
│       └── pb
├── cmd             # CLI
├── common.pb       # 放置公共的protobuf文件<span class="token punctuation">[</span>可抽离<span class="token punctuation">]</span>
├── conf            # 项目配置对象
├── docs            # 项目相关文档
├── etc             # 项目具体配置
├── ioc             # IoC容器<span class="token punctuation">[</span>可抽离<span class="token punctuation">]</span>
├── protocol        # 提供协议
├── utils           # 工具包
└── version         # 版本信息
</code></pre></div><h5 id="部分主要文件概览-解读"><a href="#部分主要文件概览-解读" class="header-anchor">#</a> 部分主要文件概览[解读]</h5> <div class="language-tex extra-class"><pre class="language-tex"><code>├── apps                            # 所有的业务模块
│   ├── all                         # 驱动注册所有的IOC容器实例
│   │   └── auto_register.go
│   ├── user                        # 以用户模块举例
│   │   ├── api                     # 提供的 API 接口
│   │   │   ├── http.go             # 使用 HTTP 的方式暴露 控制层逻辑
│   │   │   └── user.go             # user服务模块暴露的方法
│   │   ├── app.go                  # user模块的结构体方法
│   │   ├── impl                    # user.ServerService 的实现
│   │   │   ├── dao.go              # 可以看作是 持久层逻辑
│   │   │   ├── impl.go             # 可以看作是 业务层逻辑
│   │   │   ├── user.go             # user.ServerService 接口方法的实现
│   │   │   └── user_test.go        # 此模块测试用例【注：必写，一般用于测试本模块CURD的功能】
│   │   ├── pb                      # 此模块的protobuf文件，里面有（接口方法、请求model、响应model、本模块model）
│   │   │   └── user.proto      
│   │   ├── README.md               # 本模块说明
│   │   ├── user.pb.go              # 利用 protoc 生成（结构体）
│   │   └── user_grpc.pb.go         # 利用 protoc 生成（接口）
├── cmd                             # 用于启动项目
│   ├── root.go                     
│   └── start.go                    # 启动逻辑在这
├── common                          # 定义的公共的protobuf文件，可抽离
│   ├── common.pb.go
│   └── pb
│       └── common.proto
├── conf                            # 项目配置对象
│   ├── app.go                      # 此项目的配置
│   ├── config.go                   # 统一配置
│   ├── config_test.go              
│   ├── load.go                     # 加载所有配置
│   ├── log.go                      # 日志相关配置
│   └── mysql.go                    # mysql相关配置
├── etc
│   ├── dousheng.toml               # 项目配置文件位置【可换成其他的，用其他库解析】<span class="token punctuation">[</span>禁止上传github<span class="token punctuation">]</span>
│   └── dousheng.toml.template      # 配置文件模板<span class="token punctuation">[</span>可上传github<span class="token punctuation">]</span>
├── ioc                             # IoC容器
│   ├── all.go                      # 统一所有容器
│   ├── gin.go                      # Gin HTTP 服务容器
│   ├── grpc.go                     # GRPC 服务容器
│   └── internal.go                 # 内部服务容器
├── Makefile                        # 利用Makefile管理项目<span class="token punctuation">[</span>相当于一个脚手架<span class="token punctuation">]</span>
├── utils                           # 放置一些通用的工具
│   └── md5.go  
</code></pre></div><p>看完了目录结构，应该能很清晰的看出分了三个模块<code>（user、comment、video）</code>，并且每一个模块都有自己完全独立的“两层半”架构。</p> <p>既然还算清晰的对模块进行了划分。那为什么还要演变呢？</p> <h3 id="_2-遇到的问题"><a href="#_2-遇到的问题" class="header-anchor">#</a> （2）遇到的问题</h3> <p>尽管也是分模块开发，但是最终还是会打包并部署，还是为单体应用。不是说不行，但是可会遇到一些问题：</p> <ul><li><p>其中最主要的问题就是，这个应用最终会太复杂，以至于任何单个开发者都可能搞不懂它。</p></li> <li><p>应用无法扩展、可靠性低，一炸全炸，可能会出现严重的单点故障。</p></li> <li><p>最终，想要实现应用的敏捷性开发和部署变得很难。</p></li></ul> <p>当业务体量不大的时候，单体架构可能会更受人们青睐，也不会引入更多额外的资源、技术复杂度...</p> <p>但是当业务体量、用户体量一旦增长了起来，单体架构很难稳定的抗住冲击。再加上<code>Go-To-Byte</code>也想学习一下微服务开发。</p> <p>所以，我们进行了架构的第一次演变...</p> <h2 id="二、第一次演变"><a href="#二、第一次演变" class="header-anchor">#</a> 二、第一次演变</h2> <h3 id="_1-架构思路-2"><a href="#_1-架构思路-2" class="header-anchor">#</a> （1）架构思路</h3> <p>人类自古就有<strong>化繁为简、分而治之</strong>的思想，我们可以将一个复杂而庞大的业务，抽象成一个个简单的服务，然后单独的分开处理。我觉得这也是微服务的核心思路。</p> <p>但是，在每一个单独的服务中，我们还是保留了MVC的”两层半架构“。再来看看一些直观的表达：</p> <h4 id="_1、架构图-2"><a href="#_1、架构图-2" class="header-anchor">#</a> 1、架构图</h4> <p>我们原先根据业务功能，对模块进行了垂直划分，然后在划分出来的模块中，进行了水平划分，如下图所示：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/903f007dfda04ea3a8221373c2d86d1f~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p>从图中可以发现，拆分出来的每一个服务，我们都用不一样的端口，不一样的进程，运行了起来。对外部提供的服务，通过HTTP的方式暴露出去。而内部服务间的调用，就不再是通过文件路由引用了，而是通过GRPC协议暴露出去。</p> <p>看完了架构图，我们来看看大致的目录结构。</p> <h4 id="_2、目录结构-2"><a href="#_2、目录结构-2" class="header-anchor">#</a> 2、目录结构</h4> <h5 id="总目录结构概览-解读"><a href="#总目录结构概览-解读" class="header-anchor">#</a> 总目录结构概览[解读]</h5> <p>还是以用户中心、视频服务、评论服务举例。</p> <div class="language-tex extra-class"><pre class="language-tex"><code>DouSheng
├── dou_kit			 # ===简单的分Kit公共包===
│	.....
├── user_center			 # ===用户服务===
│	.....
└── video_service                # ===视频服务===
│	.....
└── comment_service              # ===评论服务===
│	.....
</code></pre></div><h5 id="详细一些的结构概览-解读"><a href="#详细一些的结构概览-解读" class="header-anchor">#</a> 详细一些的结构概览[解读]</h5> <p>这里以用户中心为例，展开目录结构：</p> <div class="language-tex extra-class"><pre class="language-tex"><code>DouSheng
├── dou_kit			 # ===简单的分Kit公共包===
│   ├── conf			 # 配置文件
│   ├── constant		 # 常量
│   ├── docs.sql		 # 部分文档
│   ├── exception		 # 统一error处理
│   └── ioc			 # IOC容器
├── user_center			 # ===用户服务===
│   ├── apps                     # 包含的模块
│   │   ├── token                # token模块
│   │   │   ├── impl
│   │   │   └── pb
│   │   ├── user                 # 用户模块
│   │   │   ├── api
│   │   │   ├── impl
│   │   │   └── pb
│   ├── client.rpc.middlerware   # 用户中心提供的客户端 
│   ├── cmd                      # 命令行工具
│   ├── common                   # 模块内公共工具
│   │   ├── constant
│   │   └── utils
│   ├── docs                     # 模块内文档
│   │   ├── example
│   │   ├── sql
│   │   └── static.image
│   ├── etc                      # 用户中心的配置文件
│   ├── protocol                 # 对外暴露的协议     
│   └── version                  # 用于注入版本信息
└── video_service                # ===视频服务===
│	.....
└── comment_service              # ===评论服务===
│	.....
</code></pre></div><p>看完了演进后的架构图和目录结构。其实这就是一个简单的微服务拆分了。核心就是<strong>化繁为简，分而治之</strong>的思想。我们这里仅对项目架构简单说明，很多微服务的知识并未在这一节体现。</p> <p>这样进行简单的拆分之后，分出了若干服务，并且服务间通过rpc调用，每个服务可以单独部署、单独编写、本来已经解决了单体架构的很多问题了。而且是通过功能模块划分的，更容易理解了。那为什么还有一次架构演进呢？我们又遇到了什么问题呢？</p> <h3 id="_2-遇到的问题-2"><a href="#_2-遇到的问题-2" class="header-anchor">#</a> （2）遇到的问题</h3> <p>我们在这里，首先遇到的问题就是：<strong>对外暴露的接口不统一</strong>，比如官方提供的测试APP，需要配置后端接口的主机地址+端口。只能访问一个进程内的接口。</p> <p>而我们这样的拆分方式，会同时启动很多个对外暴露HTTP服务的进程。若想要完整的通过APP测试，是几乎不可能的事情。</p> <p>必行之事，何必问天。光是因为上面所述的一个理由，我们的架构，就不得不再一次演变。还不谈会遇到的其他问题。</p> <p>那我们来看看是如何进行第二次架构演变的。</p> <h2 id="三、第二次演变"><a href="#三、第二次演变" class="header-anchor">#</a> 三、第二次演变</h2> <h3 id="_1-架构思路-3"><a href="#_1-架构思路-3" class="header-anchor">#</a> （1）架构思路</h3> <p><strong>“没有什么是加一层解决不了的事情，如果有，那就两层”</strong>。相信大家都听过这句话。</p> <p>是啊，我们遇到了上面的问题之后，尝试加入了一层：<code>Api Rooter</code>来解决这个问题。</p> <p>解决了吗？加入了这一层，我们对外暴露的HTTP接口，就可以统一在这一层做了。而由这一层，通过GRPC去调用内部服务实际的业务逻辑。</p> <p>来看一些较为直观的表达，再继续探讨。</p> <h4 id="_1、架构图-3"><a href="#_1、架构图-3" class="header-anchor">#</a> 1、架构图</h4> <p>主要呈现的是服务的拆分关系。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5223f7cab6f74716af4c14a37ee3ff90~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p>如图所示，对外暴露的HTTP服务，全是经过<code>Api Rooter</code>这一层出去的。在这一层，主要做两件事情。</p> <ol><li>管理<code>Token</code>的认证[提供Gin的认证中间件]</li> <li>组装<code>Api</code>，对外提供HTTP服务</li></ol> <p>因为Token相当于是用户的身份凭证，以前是放在用户中心的，现在是放在<code>Api Rooter</code>的，因为放在这里，当有请求过来的时候，若需要校验信息，直接调用方法即可。就不需要额外走GRPC去调用<code>user_center</code>的方法了。</p> <p>我们这里其实并没有太多组合Api的接口。我们的接口大多数是已经在内部服务组装好的。然后在这一层直接暴露出去即可。相当于<strong>这是各个HTTP服务Handler的聚集地</strong>。在这里聚集，然后统一暴露给外界。</p> <p>值得一提的是，这一层，是通过GRPC去调用内部服务的，并不是通过HTTP协议去调用的。主要是因为这是自定义的Api组合层，支持GRPC去调用自己的服务。</p> <h4 id="_2、目录结构-3"><a href="#_2、目录结构-3" class="header-anchor">#</a> 2、目录结构</h4> <p>加入了Api这一层、把一些公共模块更进一步的抽离出来后，现在的目录结构是这样的：</p> <div class="language-tex extra-class"><pre class="language-tex"><code>DouSheng
├── .github.workflows
├── api_rooter              # ===简易版网关===
│   ├── apps                
│   │   ├── token           # Token的 RPC Server
│   │   │   ├── impl        
│   │   │   └── pb
│   │   ├── user.api        # 用户中心的HTTP接口
│   │   └── video.api       # 视频服务的HTTP接口
│   ├── client.rpc          # Token的RPC Client
│   ├── common  
│   │   ├── all
│   │   └── utils
│   ├── docs
│   ├── etc
│   └── protocol
├── dou_kit                 # ===封装的公共库===
│   ├── client
│   ├── cmd
│   ├── conf
│   ├── constant
│   ├── docs
│   │   ├── sql
│   │   └── static
│   ├── exception.custom
│   ├── ioc
│   ├── protocol
│   └── version
├── guidance.docs           # ===项目文档===
├── user_center             # ===用户中心===
│   ├── apps.user
│   │   ├── impl
│   │   └── pb
│   ├── client.rpc
│   ├── common
│   │   ├── all
│   │   └── utils
│   ├── docs
│   │   ├── example
│   │   ├── sql
│   │   └── static.image
│   └── etc
└── video_service           # ===视频服务===
    ├── apps.video
    │   ├── impl
    │   └── pb
    ├── client.rpc
    ├── common
    │   ├── all
    │   ├── pb
    │   └── utils
    ├── docs.sql
    ├── etc
    └── store.aliyun
</code></pre></div><p>在加入这一层后，对外暴露接口的方式、样式、和端口，都统一了。这下就完事了嘛？未来真的不会出问题了吗？</p> <h3 id="_2-可能会遇到的问题"><a href="#_2-可能会遇到的问题" class="header-anchor">#</a> （2）可能会遇到的问题</h3> <p>我们现在是通过<code>Api Rooter</code>来统一暴露接口的。其中最致命的就是整个 <code>App Rooter</code> 属于 <code>single point of failure</code>，若在这一层出现严重的代码缺陷，或者流量洪峰，可能会引发集群宕机，出现单点故障。这个故障并不是说某一个服务宕机了，而是对外提供的HTTP接口会崩掉。</p> <p>但是由于一些原因：如项目进度、未学习的知识、技术成本....等问题。目前还没有办法再次演进。所以Dousheng最终的架构，<strong>暂定</strong>为这样了。</p> <h2 id="四、未来的设想"><a href="#四、未来的设想" class="header-anchor">#</a> 四、未来的设想</h2> <h3 id="未来架构演进思路"><a href="#未来架构演进思路" class="header-anchor">#</a> 未来架构演进思路</h3> <p>既然每一个API服务太庞大了，那我们继续利用<strong>大禹治水，分而治之</strong>的思想。将其拆分成多个服务独立的网关小组。这样就算某一服务提供的API宕机了，也不会导致所有服务宕机。也就是解决了单体故障的问题。</p> <p>在引入一层真正的网关技术<code>（API Geteway）</code>，来处理转发用户的请求。而且将一些横切面的逻辑放置到这一层。比如日志监控、安全认证等等</p> <p>大致画一幅图，也就是这个样子的：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f77fae80982429f9d4c974084add128~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20230220145446543"></p> <p>至此，我们通过两次架构的演进，相信你已经基本了解了Dousheng的架构思路。也算是入了微服务的门了~</p> <p>那在来看看，我们是如何管理Dousheng应用的生命周期的。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/Docs-DouSheng/handbook/feature.html" class="prev">
          功能特点
        </a></span> <span class="next"><a href="/Docs-DouSheng/framework/lifecycle.html">
          如何管理DouSheng应用的生命周期
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-06b3169a data-v-717a9a92><li class="level-2" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#一、初见dousheng" class="sidebar-link reco-side-一、初见dousheng" data-v-06b3169a>一、初见Dousheng</a></li><li class="level-3" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#_1-架构思路" class="sidebar-link reco-side-_1-架构思路" data-v-06b3169a>（1）架构思路</a></li><li class="level-3" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#_2-遇到的问题" class="sidebar-link reco-side-_2-遇到的问题" data-v-06b3169a>（2）遇到的问题</a></li><li class="level-2" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#二、第一次演变" class="sidebar-link reco-side-二、第一次演变" data-v-06b3169a>二、第一次演变</a></li><li class="level-3" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#_1-架构思路-2" class="sidebar-link reco-side-_1-架构思路-2" data-v-06b3169a>（1）架构思路</a></li><li class="level-3" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#_2-遇到的问题-2" class="sidebar-link reco-side-_2-遇到的问题-2" data-v-06b3169a>（2）遇到的问题</a></li><li class="level-2" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#三、第二次演变" class="sidebar-link reco-side-三、第二次演变" data-v-06b3169a>三、第二次演变</a></li><li class="level-3" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#_1-架构思路-3" class="sidebar-link reco-side-_1-架构思路-3" data-v-06b3169a>（1）架构思路</a></li><li class="level-3" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#_2-可能会遇到的问题" class="sidebar-link reco-side-_2-可能会遇到的问题" data-v-06b3169a>（2）可能会遇到的问题</a></li><li class="level-2" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#四、未来的设想" class="sidebar-link reco-side-四、未来的设想" data-v-06b3169a>四、未来的设想</a></li><li class="level-3" data-v-06b3169a><a href="/Docs-DouSheng/framework/evolve.html#未来架构演进思路" class="sidebar-link reco-side-未来架构演进思路" data-v-06b3169a>未来架构演进思路</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-e58f9186 data-v-e58f9186><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-e58f9186><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-e58f9186></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-e58f9186></path></svg></div></div></div>
    <script src="/Docs-DouSheng/assets/js/app.536cc449.js" defer></script><script src="/Docs-DouSheng/assets/js/3.7c9615c7.js" defer></script><script src="/Docs-DouSheng/assets/js/1.09f60839.js" defer></script><script src="/Docs-DouSheng/assets/js/11.fffa9699.js" defer></script>
  </body>
</html>
